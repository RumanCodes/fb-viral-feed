<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Viral Feed</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet"/>
<style>
:root{
  --bg:#08090c; --s1:#0f1118; --s2:#161b26; --s3:#1c2333;
  --bd:#1f2937; --bd2:#2d3748;
  --blue:#3b82f6; --blue2:#60a5fa; --bluedim:#1e3a5f;
  --green:#10b981; --gdim:#064e3b;
  --red:#ef4444;   --rdim:#3b1414;
  --yellow:#f59e0b;--ydim:#451a03;
  --tx:#f1f5f9; --tx2:#94a3b8; --tx3:#475569;
  --r:10px; --disp:'Syne',sans-serif; --body:'DM Sans',sans-serif;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:var(--body);background:var(--bg);color:var(--tx);min-height:100vh}

/* Header */
header{
  position:sticky;top:0;z-index:200;
  background:rgba(8,9,12,.95);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--bd);
  padding:0 20px;height:56px;
  display:flex;align-items:center;justify-content:space-between;gap:12px;
}
.logo{display:flex;align-items:center;gap:9px}
.lmark{width:30px;height:30px;background:var(--blue);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem;box-shadow:0 0 12px rgba(59,130,246,.4);flex-shrink:0}
.ltxt{font-family:var(--disp);font-size:1rem;font-weight:800;letter-spacing:-.3px}
.ltxt span{color:var(--blue2)}
.live{display:flex;align-items:center;gap:4px;background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.25);border-radius:20px;padding:3px 9px;font-size:.67rem;font-weight:700;color:var(--green);letter-spacing:.5px}
.ldot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:blink 1.8s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.2}}
.hdr-r{display:flex;align-items:center;gap:8px}
#next-lbl{font-size:.7rem;color:var(--tx3)}

/* Stats ribbon */
#ribbon{
  background:var(--s1);border-bottom:1px solid var(--bd);
  padding:0 20px;height:40px;
  display:flex;align-items:center;overflow-x:auto;scrollbar-width:none;
}
#ribbon::-webkit-scrollbar{display:none}
.stat{display:flex;align-items:center;gap:5px;padding:0 14px;border-right:1px solid var(--bd);height:100%;white-space:nowrap;font-size:.74rem}
.stat:first-child{padding-left:0}
.sl{color:var(--tx3)} .sv{color:var(--tx);font-weight:600}

/* Tabs */
.tabs{background:var(--s1);border-bottom:1px solid var(--bd);padding:0 20px;display:flex}
.tab{padding:9px 16px;font-size:.81rem;font-weight:600;cursor:pointer;border-bottom:2px solid transparent;color:var(--tx3);transition:all .18s;white-space:nowrap}
.tab:hover{color:var(--tx2)} .tab.active{color:var(--blue2);border-bottom-color:var(--blue)}

/* Toolbar */
#toolbar{background:var(--s1);border-bottom:1px solid var(--bd);padding:9px 20px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.swrap{position:relative;flex:1;min-width:150px;max-width:240px}
.swrap svg{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--tx3);pointer-events:none}
input[type=text]{width:100%;background:var(--s2);border:1px solid var(--bd2);color:var(--tx);border-radius:var(--r);padding:7px 11px 7px 30px;font-size:.82rem;font-family:var(--body);outline:none;transition:border-color .2s}
input[type=text]:focus{border-color:var(--blue)}
input[type=text]::placeholder{color:var(--tx3)}
select{background:var(--s2);border:1px solid var(--bd2);color:var(--tx);border-radius:var(--r);padding:7px 9px;font-size:.81rem;font-family:var(--body);cursor:pointer;outline:none}
select:focus{border-color:var(--blue)}
.pills{display:flex;gap:5px;flex-wrap:wrap}
.pill{padding:4px 11px;border-radius:20px;font-size:.73rem;font-weight:600;cursor:pointer;border:1px solid var(--bd2);background:var(--s2);color:var(--tx2);transition:all .17s;white-space:nowrap;user-select:none}
.pill:hover{border-color:var(--blue);color:var(--blue2)} .pill.active{background:var(--blue);border-color:var(--blue);color:#fff}
.btn{display:inline-flex;align-items:center;gap:5px;padding:7px 13px;border-radius:var(--r);font-size:.81rem;font-weight:600;font-family:var(--body);cursor:pointer;border:none;transition:all .18s;white-space:nowrap}
.bp{background:var(--blue);color:#fff} .bp:hover{background:#2563eb} .bp:active{transform:scale(.97)} .bp:disabled{opacity:.5;cursor:not-allowed;transform:none}
.bg{background:var(--s2);border:1px solid var(--bd2);color:var(--tx2)} .bg:hover{border-color:var(--blue);color:var(--blue2)}

/* Result bar */
#rbar{padding:6px 20px 0;font-size:.72rem;color:var(--tx3);max-width:1600px;margin:0 auto}

/* Feed grid */
#feed{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:14px;padding:14px 20px 40px;max-width:1600px;margin:0 auto}

/* Card */
.card{background:var(--s1);border:1px solid var(--bd);border-radius:13px;overflow:hidden;display:flex;flex-direction:column;transition:transform .22s,box-shadow .22s,border-color .22s}
.card:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(0,0,0,.45);border-color:var(--bd2)}
.cthumb{position:relative;aspect-ratio:16/9;background:var(--s2);overflow:hidden;flex-shrink:0}
.cthumb img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .35s}
.card:hover .cthumb img{transform:scale(1.05)}
.cstripe{position:absolute;top:0;left:0;right:0;height:3px}
.cnoimg{width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;color:var(--tx3);font-size:.76rem;background:var(--s2)}
.cnoimg-ic{font-size:1.7rem;opacity:.3}
.cbadge{position:absolute;bottom:7px;right:7px;border-radius:5px;padding:2px 7px;font-size:.61rem;font-weight:800;letter-spacing:.5px;text-transform:uppercase;background:rgba(0,0,0,.65);backdrop-filter:blur(4px);color:#fff}
.cbody{padding:11px 13px 13px;flex:1;display:flex;flex-direction:column;gap:7px}
.csource{display:flex;align-items:center;gap:5px}
.cdot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.cname{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.ctime{font-size:.67rem;color:var(--tx3);margin-left:auto}
.ctitle{font-family:var(--disp);font-size:.9rem;font-weight:700;color:var(--tx);line-height:1.42;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;flex:1}
.cdesc{font-size:.77rem;color:var(--tx2);line-height:1.5;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cfooter{display:flex;align-items:center;justify-content:flex-end;padding-top:5px;border-top:1px solid var(--bd);margin-top:auto}
.rlink{font-size:.72rem;font-weight:600;color:var(--blue2);text-decoration:none;display:flex;align-items:center;gap:3px;transition:gap .15s}
.rlink:hover{gap:6px}

/* States */
.fullcol{grid-column:1/-1}
.sbox{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:70px 20px;gap:12px;text-align:center;color:var(--tx3)}
.sicon{font-size:2.7rem;opacity:.4}
.sbox p{font-size:.87rem;max-width:290px;line-height:1.6}
.spin{width:36px;height:36px;border:3px solid var(--bd2);border-top-color:var(--blue);border-radius:50%;animation:rot .65s linear infinite}
@keyframes rot{to{transform:rotate(360deg)}}

/* Toast */
#toast{position:fixed;bottom:16px;right:16px;background:var(--s3);border:1px solid var(--bd2);color:var(--tx);border-radius:var(--r);padding:10px 15px;font-size:.81rem;font-weight:500;opacity:0;transform:translateY(8px);transition:all .25s;z-index:999;pointer-events:none;max-width:270px}
#toast.show{opacity:1;transform:translateY(0)} #toast.ok{border-color:var(--green)} #toast.err{border-color:var(--red)}

/* Source Manager Panel */
#panel{max-width:820px;margin:18px auto;padding:0 20px 40px;display:none;flex-direction:column;gap:14px}
#panel.on{display:flex}
.pcard{background:var(--s1);border:1px solid var(--bd);border-radius:13px;overflow:hidden}
.phead{padding:11px 15px;background:var(--s2);border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between}
.phead h2{font-family:var(--disp);font-size:.92rem;font-weight:700}
.phead p{font-size:.73rem;color:var(--tx2);margin-top:2px}
.pbody{padding:14px}

/* Input groups */
.irow{display:flex;gap:7px;flex-wrap:wrap}
.irow input,.irow select{flex:1;min-width:130px;padding:8px 11px}
.irow input[type=text]{padding:8px 11px}
.irow input[type=color]{flex:none;width:40px;padding:3px;cursor:pointer;background:var(--s2);border:1px solid var(--bd2);border-radius:var(--r);height:34px}

/* Result boxes */
.rbox{margin-top:12px;border-radius:9px;padding:11px 13px;border:1px solid;font-size:.81rem;line-height:1.6;display:none}
.rbox.on{display:block}
.rbox.ok{background:var(--gdim);border-color:rgba(16,185,129,.3);color:#6ee7b7}
.rbox.err{background:var(--rdim);border-color:rgba(239,68,68,.3);color:#fca5a5}
.rbox.warn{background:var(--ydim);border-color:rgba(245,158,11,.3);color:#fcd34d}
.rtitle{font-weight:700;font-size:.86rem;margin-bottom:4px}
.rmeta{display:flex;flex-wrap:wrap;gap:8px;margin-top:7px}
.rchip{background:rgba(255,255,255,.07);border-radius:5px;padding:2px 8px;font-size:.71rem;font-weight:600}
.rtip{margin-top:8px;padding:8px 10px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.2);border-radius:7px;font-size:.76rem;color:var(--blue2)}

/* Alt rows */
.alts{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.altrow{display:flex;align-items:center;gap:9px;padding:8px 11px;background:var(--s2);border:1px solid var(--bd);border-radius:8px;cursor:pointer;transition:border-color .18s}
.altrow:hover{border-color:var(--blue)}
.altic{font-size:1.1rem;flex-shrink:0}
.altin{flex:1;min-width:0}
.altnm{font-size:.81rem;font-weight:600}
.alturl{font-size:.69rem;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.altuse{font-size:.71rem;font-weight:600;color:var(--blue2);flex-shrink:0}

/* Sources list */
.srclist{display:flex;flex-direction:column;gap:5px;max-height:340px;overflow-y:auto}
.srcrow{display:flex;align-items:center;gap:9px;padding:8px 11px;background:var(--s2);border:1px solid var(--bd);border-radius:8px}
.srcc{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.srci{flex:1;min-width:0}
.srct{font-size:.81rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.srcu{font-size:.69rem;color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.srccat{font-size:.64rem;font-weight:700;text-transform:uppercase;letter-spacing:.4px;color:var(--tx3);flex-shrink:0}
.srcrm{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:.78rem;padding:2px 5px;border-radius:4px;transition:all .15s;font-family:var(--body)}
.srcrm:hover{background:var(--rdim);color:var(--red)}

@media(max-width:620px){
  header,.tabs,#toolbar,#ribbon,#feed,#rbar,#panel{padding-left:12px;padding-right:12px}
  #feed{gap:11px} .ltxt{display:none}
}
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="lmark">üì°</div>
    <span class="ltxt">Viral <span>Feed</span></span>
    <div class="live"><div class="ldot"></div>LIVE</div>
  </div>
  <div class="hdr-r">
    <span id="next-lbl"></span>
    <button class="btn bp" id="fbtn" onclick="fetchNow()">‚ö° Fetch Now</button>
  </div>
</header>

<div id="ribbon">
  <div class="stat"><span class="sl">Articles</span><span class="sv" id="st">‚Äî</span></div>
  <div class="stat"><span class="sl">Images</span><span class="sv" id="si">‚Äî</span></div>
  <div class="stat"><span class="sl">Sources</span><span class="sv" id="ss">‚Äî</span></div>
  <div class="stat"><span class="sl">Categories</span><span class="sv" id="sc">‚Äî</span></div>
  <div class="stat"><span class="sl">Updated</span><span class="sv" id="su">‚Äî</span></div>
</div>

<div class="tabs">
  <div class="tab active" onclick="tab('feed',this)">üì∞ Feed</div>
  <div class="tab"        onclick="tab('mgr',this)">üîß Source Manager</div>
</div>

<div id="toolbar">
  <div class="swrap">
    <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    <input type="text" id="q" placeholder="Search headlines‚Ä¶" oninput="filter()"/>
  </div>
  <div class="pills" id="cpills"><div class="pill active" data-c="all" onclick="setCat(this)">All</div></div>
  <select id="sf" onchange="filter()"><option value="all">All Sources</option></select>
  <select id="so" onchange="filter()">
    <option value="date">Newest First</option>
    <option value="source">By Source</option>
  </select>
  <button class="btn bg" onclick="loadPosts()">‚Ü∫ Refresh</button>
</div>

<div id="rbar"></div>
<div id="feed"></div>

<!-- Source Manager -->
<div id="panel">

  <!-- Find RSS for FB page -->
  <div class="pcard">
    <div class="phead"><div><h2>üîç Find RSS for a Facebook Page</h2><p>Type a page name ‚Äî we'll find its real working RSS feed</p></div></div>
    <div class="pbody">
      <div class="irow">
        <input type="text" id="fbin" placeholder="e.g. NASA, BBC News, CNN, TechCrunch‚Ä¶" style="padding:8px 11px"/>
        <button class="btn bp" onclick="findAlt()">Find Feed</button>
      </div>
      <div id="altbox"></div>
    </div>
  </div>

  <!-- Test URL -->
  <div class="pcard">
    <div class="phead"><div><h2>‚úÖ Test a Feed URL</h2><p>Paste any RSS/YouTube/Reddit URL to check if it works</p></div></div>
    <div class="pbody">
      <div class="irow">
        <input type="text" id="turl" placeholder="https://example.com/feed  or  https://www.reddit.com/r/NAME/hot.rss"/>
        <button class="btn bp" id="tbtn" onclick="testFeed()">Test</button>
      </div>
      <div id="tbox" class="rbox"></div>
    </div>
  </div>

  <!-- Add source -->
  <div class="pcard">
    <div class="phead"><div><h2>‚ûï Add Source</h2><p>Add any working RSS, Reddit, or YouTube feed</p></div></div>
    <div class="pbody">
      <div class="add-form" style="display:flex;flex-direction:column;gap:9px">
        <div class="irow">
          <input type="text" id="aname" placeholder="Source name"/>
          <input type="text" id="acat"  placeholder="Category"/>
          <input type="color" id="acolor" value="#3b82f6"/>
        </div>
        <div class="irow">
          <input type="text" id="aurl" placeholder="RSS feed URL"/>
          <button class="btn bp" id="abtn" onclick="addSrc()">Add Source</button>
        </div>
        <div id="abox" class="rbox"></div>
      </div>
    </div>
  </div>

  <!-- Active sources -->
  <div class="pcard">
    <div class="phead"><div><h2>üìã Active Sources</h2><p>All configured RSS sources</p></div></div>
    <div class="pbody"><div class="srclist" id="srclist"><div style="color:var(--tx3);font-size:.81rem">Loading‚Ä¶</div></div></div>
  </div>

</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ FB ‚Üí Official RSS lookup table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FB_MAP = {
  "nasa":            [{ic:"üöÄ",nm:"NASA Breaking News",url:"https://www.nasa.gov/rss/dyn/breaking_news.rss",tp:"RSS"},{ic:"‚ñ∂Ô∏è",nm:"NASA YouTube",url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCLA_DiR1FfKNvjuUpBHmylQ",tp:"YouTube"}],
  "bbc":             [{ic:"üì∫",nm:"BBC News (Top)",url:"https://feeds.bbci.co.uk/news/rss.xml",tp:"RSS"},{ic:"üåç",nm:"BBC World",url:"https://feeds.bbci.co.uk/news/world/rss.xml",tp:"RSS"}],
  "bbc news":        [{ic:"üì∫",nm:"BBC News (Top)",url:"https://feeds.bbci.co.uk/news/rss.xml",tp:"RSS"},{ic:"üåç",nm:"BBC World",url:"https://feeds.bbci.co.uk/news/world/rss.xml",tp:"RSS"}],
  "bbcnews":         [{ic:"üì∫",nm:"BBC News (Top)",url:"https://feeds.bbci.co.uk/news/rss.xml",tp:"RSS"}],
  "cnn":             [{ic:"üì°",nm:"CNN Top Stories",url:"https://rss.cnn.com/rss/cnn_topstories.rss",tp:"RSS"},{ic:"üí∞",nm:"CNN Business",url:"https://rss.cnn.com/rss/money_news_international.rss",tp:"RSS"}],
  "reuters":         [{ic:"üì∞",nm:"Reuters Top News",url:"https://feeds.reuters.com/reuters/topNews",tp:"RSS"}],
  "al jazeera":      [{ic:"üåê",nm:"Al Jazeera",url:"https://www.aljazeera.com/xml/rss/all.xml",tp:"RSS"}],
  "aljazeera":       [{ic:"üåê",nm:"Al Jazeera",url:"https://www.aljazeera.com/xml/rss/all.xml",tp:"RSS"}],
  "guardian":        [{ic:"üì∞",nm:"The Guardian World",url:"https://www.theguardian.com/world/rss",tp:"RSS"}],
  "the guardian":    [{ic:"üì∞",nm:"The Guardian World",url:"https://www.theguardian.com/world/rss",tp:"RSS"}],
  "npr":             [{ic:"üéô",nm:"NPR News",url:"https://feeds.npr.org/1001/rss.xml",tp:"RSS"}],
  "techcrunch":      [{ic:"üíª",nm:"TechCrunch",url:"https://techcrunch.com/feed/",tp:"RSS"}],
  "verge":           [{ic:"‚ö°",nm:"The Verge",url:"https://www.theverge.com/rss/index.xml",tp:"RSS"}],
  "the verge":       [{ic:"‚ö°",nm:"The Verge",url:"https://www.theverge.com/rss/index.xml",tp:"RSS"}],
  "wired":           [{ic:"üí°",nm:"Wired",url:"https://www.wired.com/feed/rss",tp:"RSS"}],
  "ars technica":    [{ic:"üîß",nm:"Ars Technica",url:"https://feeds.arstechnica.com/arstechnica/index",tp:"RSS"}],
  "hacker news":     [{ic:"üü†",nm:"Hacker News",url:"https://hnrss.org/frontpage",tp:"RSS"}],
  "national geographic":[{ic:"üåç",nm:"Nat Geographic",url:"https://www.nationalgeographic.com/latest-stories/_jcr_content/list.rss",tp:"RSS"}],
  "natgeo":          [{ic:"üåç",nm:"Nat Geographic",url:"https://www.nationalgeographic.com/latest-stories/_jcr_content/list.rss",tp:"RSS"}],
  "science daily":   [{ic:"üî¨",nm:"Science Daily",url:"https://www.sciencedaily.com/rss/top/science.xml",tp:"RSS"}],
  "new scientist":   [{ic:"üß™",nm:"New Scientist",url:"https://www.newscientist.com/feed/home/",tp:"RSS"}],
  "cnbc":            [{ic:"üìà",nm:"CNBC",url:"https://www.cnbc.com/id/100003114/device/rss/rss.html",tp:"RSS"}],
  "forbes":          [{ic:"üíº",nm:"Forbes",url:"https://www.forbes.com/feeds/entrepreneur/index.xml",tp:"RSS"}],
  "variety":         [{ic:"üé¨",nm:"Variety",url:"https://variety.com/feed/",tp:"RSS"}],
  "reddit":          [{ic:"üî¥",nm:"r/worldnews",url:"https://www.reddit.com/r/worldnews/hot.rss",tp:"Reddit"},{ic:"üî¥",nm:"r/technology",url:"https://www.reddit.com/r/technology/hot.rss",tp:"Reddit"}],
  "veritasium":      [{ic:"‚ñ∂Ô∏è",nm:"Veritasium",url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCHnyfMqiRRG1u-2MsSQLbXA",tp:"YouTube"}],
  "kurzgesagt":      [{ic:"‚ñ∂Ô∏è",nm:"Kurzgesagt",url:"https://www.youtube.com/feeds/videos.xml?channel_id=UCsXVk37bltHxD1rDPwtNM8Q",tp:"YouTube"}],
};

// ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const $  = id => document.getElementById(id);
const e  = s => String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
const ago= d => { if(!d) return ""; const s=(Date.now()-new Date(d))/1000; if(s<60) return "just now"; if(s<3600) return ~~(s/60)+"m ago"; if(s<86400) return ~~(s/3600)+"h ago"; return ~~(s/86400)+"d ago"; };
const toast=(m,t="")=>{const n=$("toast");n.textContent=m;n.className="show "+t;clearTimeout(n._t);n._t=setTimeout(()=>n.className="",3000)};

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tab(id, el) {
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");
  const onFeed = id === "feed";
  $("toolbar").style.display = onFeed ? "" : "none";
  $("rbar").style.display    = onFeed ? "" : "none";
  $("feed").style.display    = onFeed ? "" : "none";
  const p = $("panel"); p.className = onFeed ? "" : "on";
  if (!onFeed) loadSrcList();
}

// ‚îÄ‚îÄ Feed ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let posts=[], cats=[], srcs=[], curCat="all";

async function loadPosts() {
  showSpin();
  try {
    const r = await fetch("/api/posts");
    if (!r.ok) throw new Error("HTTP " + r.status);
    const d = await r.json();
    posts = d.posts || [];

    // Build category pills
    const nc = [...new Set(posts.map(p=>p.category).filter(Boolean))].sort();
    if (JSON.stringify(nc) !== JSON.stringify(cats)) {
      cats = nc;
      const pp = $("cpills"); pp.innerHTML = "";
      ["all",...cats].forEach(c => {
        const d = document.createElement("div");
        d.className = "pill" + (c===curCat?" active":"");
        d.dataset.c = c; d.textContent = c==="all"?"All":c;
        d.onclick = () => setCat(d); pp.appendChild(d);
      });
    }

    // Build source dropdown
    const ns = [...new Set(posts.map(p=>p.page))].sort();
    if (JSON.stringify(ns) !== JSON.stringify(srcs)) {
      srcs = ns;
      const sel = $("sf"); sel.innerHTML = '<option value="all">All Sources</option>';
      srcs.forEach(s => { const o=document.createElement("option"); o.value=s; o.textContent=s; sel.appendChild(o); });
    }
    filter();
  } catch(err) {
    showEmpty("‚ö†Ô∏è Could not load posts. Is the server running?\n" + err.message);
  }
}

function filter() {
  const q   = $("q").value.toLowerCase();
  const src = $("sf").value;
  const srt = $("so").value;

  let f = posts.filter(p => {
    const cok = curCat==="all" || p.category===curCat;
    const sok = src==="all"    || p.page===src;
    const qok = !q || (p.message||"").toLowerCase().includes(q) || (p.description||"").toLowerCase().includes(q);
    return cok && sok && qok;
  });

  if (srt==="source") f.sort((a,b)=>a.page.localeCompare(b.page));
  else f.sort((a,b)=>new Date(b.createdTime)-new Date(a.createdTime));

  $("rbar").textContent = f.length ? `Showing ${f.length} article${f.length!==1?"s":""}` : "";
  render(f);
}

function render(list) {
  const feed = $("feed");
  if (!list.length) { showEmpty("No articles yet ‚Äî click ‚ö° Fetch Now or add sources in Source Manager."); return; }
  const frag = document.createDocumentFragment();
  list.forEach(p => frag.appendChild(mkCard(p)));
  feed.innerHTML = ""; feed.appendChild(frag);
}

function mkCard(p) {
  const card = document.createElement("div"); card.className = "card";
  const col  = p.color || "#3b82f6";
  const tp   = p.sourceType || p.mediaType || "";
  const badge= tp==="youtube"?"‚ñ∂ YT":tp==="reddit"?"üî¥ REDDIT":tp==="video"?"‚ñ∂ VIDEO":tp==="photo"?"üì∏ PHOTO":"";
  const thumb= p.mediaUrl
    ? `<img src="${e(p.mediaUrl)}" alt="" loading="lazy" onerror="this.parentElement.innerHTML='<div class=cnoimg><div class=cnoimg-ic>üì∞</div><span>${e(p.page)}</span></div>'">`
    : `<div class="cnoimg"><div class="cnoimg-ic">üì∞</div><span>${e(p.page)}</span></div>`;
  card.innerHTML = `
    <div class="cthumb">
      <div class="cstripe" style="background:${col}"></div>
      ${thumb}
      ${badge?`<div class="cbadge">${badge}</div>`:""}
    </div>
    <div class="cbody">
      <div class="csource">
        <div class="cdot" style="background:${col}"></div>
        <span class="cname" style="color:${col}">${e(p.page)}</span>
        <span class="ctime">${ago(p.createdTime)}</span>
      </div>
      <div class="ctitle">${e(p.message)}</div>
      ${p.description&&p.description!==p.message?`<div class="cdesc">${e(p.description)}</div>`:""}
      ${p.permalink?`<div class="cfooter"><a class="rlink" href="${e(p.permalink)}" target="_blank" rel="noopener">Read article ‚Üí</a></div>`:""}
    </div>`;
  return card;
}

function setCat(el) { document.querySelectorAll(".pill").forEach(p=>p.classList.remove("active")); el.classList.add("active"); curCat=el.dataset.c; filter(); }
function showSpin() { $("feed").innerHTML=`<div class="fullcol sbox"><div class="spin"></div><p>Loading‚Ä¶</p></div>`; $("rbar").textContent=""; }
function showEmpty(m) { $("feed").innerHTML=`<div class="fullcol sbox"><div class="sicon">üì≠</div><p>${m}</p></div>`; $("rbar").textContent=""; }

async function fetchNow() {
  const btn=$("fbtn"); btn.disabled=true; btn.textContent="‚è≥ Fetching‚Ä¶";
  try {
    const r=await fetch("/api/fetch-now",{method:"POST"});
    const d=await r.json();
    if(d.success){ toast(`‚úì ${d.fetched} articles fetched!`,"ok"); await Promise.all([loadPosts(),loadStats()]); }
    else toast("‚ö†Ô∏è "+d.error,"err");
  } catch { toast("‚ö†Ô∏è Network error","err"); }
  btn.disabled=false; btn.textContent="‚ö° Fetch Now";
}

async function loadStats() {
  try {
    const [sr,nr] = await Promise.all([fetch("/api/stats"),fetch("/api/next-run")]);
    const s=await sr.json(); const n=await nr.json();
    $("st").textContent = s.totalPosts;
    $("si").textContent = s.withImages;
    $("ss").textContent = s.sources.length;
    $("sc").textContent = s.categories.length;
    $("su").textContent = s.lastFetched ? ago(s.lastFetched) : "Never";
    if(n.nextRun) $("next-lbl").textContent = "Next: "+new Date(n.nextRun).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});
  } catch {}
}

// ‚îÄ‚îÄ Source Manager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function findAlt() {
  const raw = $("fbin").value.trim().toLowerCase()
    .replace(/https?:\/\/(www\.)?facebook\.com\//i,"").replace(/\//g,"");
  const box = $("altbox");
  if (!raw) return;

  // Try exact then partial
  let alts = FB_MAP[raw];
  if (!alts) {
    for (const [k,v] of Object.entries(FB_MAP)) {
      if (k.includes(raw)||raw.includes(k)) { alts=v; break; }
    }
  }

  if (!alts) {
    box.innerHTML=`<div class="rbox warn on" style="margin-top:10px">
      <div class="rtitle">‚ö†Ô∏è No known RSS found for "${e(raw)}"</div>
      <div class="rtip"><strong>What to do:</strong> Visit the page on Facebook ‚Üí click About ‚Üí find their website ‚Üí try adding /rss or /feed to that URL ‚Üí paste it in the Test URL section below.</div>
    </div>`;
    return;
  }

  box.innerHTML=`<p style="font-size:.76rem;color:var(--tx2);margin-top:10px;margin-bottom:6px">‚úÖ ${alts.length} working feed${alts.length>1?"s":""} found ‚Äî click one to use it:</p>`;
  const list = document.createElement("div"); list.className="alts";
  alts.forEach(a=>{
    const row=document.createElement("div"); row.className="altrow";
    row.innerHTML=`<div class="altic">${a.ic}</div><div class="altin"><div class="altnm">${e(a.nm)} <span style="font-size:.64rem;color:var(--tx3)">[${a.tp}]</span></div><div class="alturl">${e(a.url)}</div></div><div class="altuse">Use ‚Üí</div>`;
    row.onclick=()=>{ $("aurl").value=a.url; $("aname").value=a.nm; $("acat").value=a.tp==="YouTube"?"YouTube":a.tp==="Reddit"?"Reddit":"World"; toast("Feed loaded ‚Äî fill in details and click Add Source"); };
    list.appendChild(row);
  });
  box.appendChild(list);
}

async function testFeed() {
  const url=$("turl").value.trim();
  if(!url){ toast("Enter a URL first","err"); return; }
  const btn=$("tbtn"); btn.disabled=true; btn.textContent="Testing‚Ä¶";
  const box=$("tbox"); box.className="rbox on"; box.innerHTML="<div style='color:var(--tx2)'>‚è≥ Testing‚Ä¶</div>";
  try {
    const r=await fetch("/api/validate-feed",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({url})});
    const d=await r.json();
    if(d.ok){
      box.className="rbox ok on";
      box.innerHTML=`<div class="rtitle">‚úÖ Feed is working!</div>
        <div><strong>${e(d.title)}</strong></div>
        <div class="rmeta">
          <div class="rchip">üìÑ ${d.itemCount} items</div>
          <div class="rchip">üì° ${d.feedType}</div>
          ${d.latestItem?`<div class="rchip">üïê ${e(d.latestItem.date?.substring(0,16)||"")}</div>`:""}
        </div>
        ${d.latestItem?`<div style="margin-top:7px;font-size:.74rem;color:var(--tx2)">Latest: <em>${e(d.latestItem.title)}</em></div>`:""}`;
      $("aurl").value=url; if(!$("aname").value) $("aname").value=d.title||"";
    } else {
      box.className=`rbox ${d.isFacebookDead?"warn":"err"} on`;
      box.innerHTML=`<div class="rtitle">${d.isFacebookDead?"‚ö†Ô∏è Facebook RSS Is Dead":"‚ùå Not Working"}</div>
        <div>${e(d.error)}</div>
        ${d.suggestion?`<div class="rtip"><strong>üí° Tip:</strong> ${e(d.suggestion)}</div>`:""}
        ${d.isFacebookDead?`<div class="rtip" style="margin-top:6px"><strong>‚úÖ Fix:</strong> Use the "Find RSS" section above to get a working alternative.</div>`:""}`;
    }
  } catch(err) {
    box.className="rbox err on";
    box.innerHTML=`<div class="rtitle">‚ùå Error</div><div>${e(err.message)}</div>`;
  }
  btn.disabled=false; btn.textContent="Test";
}

async function addSrc() {
  const name=$("aname").value.trim();
  const url =$("aurl").value.trim();
  const cat =$("acat").value.trim()||"Custom";
  const col =$("acolor").value;
  if(!name||!url){ toast("Name and URL required","err"); return; }
  const btn=$("abtn"); btn.disabled=true; btn.textContent="Adding‚Ä¶";
  const box=$("abox"); box.className="rbox on"; box.innerHTML="<div style='color:var(--tx2)'>‚è≥ Validating‚Ä¶</div>";
  try {
    const r=await fetch("/api/add-source",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name,url,category:cat,color:col})});
    const d=await r.json();
    if(d.ok){
      box.className="rbox ok on";
      box.innerHTML=`<div class="rtitle">‚úÖ "${e(name)}" added!</div><div>${e(d.message)}</div>`;
      $("aname").value=""; $("aurl").value=""; $("acat").value="";
      loadSrcList(); toast(`"${name}" added ‚Äî click Fetch Now`,"ok");
    } else {
      box.className="rbox err on";
      box.innerHTML=`<div class="rtitle">‚ùå Could not add</div><div>${e(d.error)}</div>${d.suggestion?`<div class="rtip">${e(d.suggestion)}</div>`:""}`;
    }
  } catch(err) {
    box.className="rbox err on"; box.innerHTML=`<div class="rtitle">‚ùå Error</div><div>${e(err.message)}</div>`;
  }
  btn.disabled=false; btn.textContent="Add Source";
}

async function loadSrcList() {
  const list=$("srclist");
  try {
    const r=await fetch("/api/sources"); const d=await r.json();
    if(!d.sources?.length){ list.innerHTML=`<div style="color:var(--tx3);font-size:.81rem;padding:6px">No sources configured.</div>`; return; }
    list.innerHTML="";
    d.sources.forEach(s=>{
      const row=document.createElement("div"); row.className="srcrow";
      row.innerHTML=`<div class="srcc" style="background:${e(s.color)}"></div><div class="srci"><div class="srct">${e(s.name)}</div><div class="srcu">${e(s.url)}</div></div><div class="srccat">${e(s.category)}</div><button class="srcrm" onclick="rmSrc('${e(s.name)}')">‚úï</button>`;
      list.appendChild(row);
    });
  } catch { list.innerHTML=`<div style="color:var(--tx3);font-size:.81rem;padding:6px">Could not load.</div>`; }
}

async function rmSrc(name) {
  if(!confirm(`Remove "${name}"?`)) return;
  try {
    await fetch(`/api/remove-source/${encodeURIComponent(name)}`,{method:"DELETE"});
    toast(`"${name}" removed`,"ok"); loadSrcList();
  } catch { toast("Failed to remove","err"); }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
loadPosts();
loadStats();
setInterval(loadStats, 30000);
</script>
</body>
</html>